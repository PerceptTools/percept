#---------------------------------------------------------------
#    Copyright 2010 - 2010 Sandia Corporation.
#    Under the terms of Contract DE-AC04-94AL85000, there is a
#    non-exclusive license for use of this work by or on behalf
#    of the U.S. Government.  Export of this program may require
#    a license from the United States Government.
#---------------------------------------------------------------

#
# The signature for Boost.build rules is described here:
#
# http://www.boost.org/build/doc/html/bbv2/overview/targets.html
#
#function-name main-target-name
#    : sources
#    : requirements
#    : default-build
#    : usage-requirements
#    ;
#
#    * "main-target-name" is the name used to request the target
#            on command line and to use it from other main targets.
#            Main target name may contain alphanumeric characters and symbols '-' and '_';
#    * "sources" is the list of source files and other main targets that must be combined.
#    * "requirements" is the list of properties that must always be present
#            when this main target is built.
#    * "default-build" is the list of properties that will be used unless
#            some other value of the same feature is already specified.
#    * "usage-requirements" is the list of properties that will be propagated
#            to all main targets that use this one, i.e. to all dependedents.
#
#
# SECTION 1: Project definition
#

import set ;
import path ;

local percept-root-inc ;

if $(RTenv-arg) = "user" {
  percept-root-inc = $(percept-root)/include ;
} else {
  percept-root-inc = $(percept-root)/src ;
}

local percept-root-src = $(percept-root)/src ;
local percept-root-test = $(percept-root)/test ;

 
import os ;
local acis-root = [ os.environ "ACIS_ROOT" ] ; 


project votd
  : requirements
    $(sierra-warnings)
    <include>$(percept-root-src)
    <include>$(percept-root-test)
    <define>STK_BUILT_IN_SIERRA
    [ if-defined-val $(acis-root) : <define>HAVE_ACIS=1 ]
  : usage-requirements
    <include>$(percept-root-inc)
  : build-dir $(percept-builddir)
  ;

#
# SECTION 2: Development install
#
explicit install-serial-targets ;
alias install-serial-targets ;

explicit install-targets ;
alias install-targets
  : percept_utest
    percept_verifier_mesh
    percept_mesh_diff
    eigen_verify
    mesh_transfer
    percept_rtest
    mesh_adapt
    percept_htest
    rfgen_unit
    rfsuite_unit
    rfsuite
  ;

#
# SECTION 3: End-user install
#
explicit install-user-env ;
alias install-user-env : install-user-jamfile
                          install-user-bin install-user-include install-user-lib ;

# This rule copies build-system related files for this product to the install-root.
explicit install-user-jamfile ;
install install-user-jamfile
  : [ glob $(percept-root)/Jamfile ]
  : <location>$(install-root)/percept
    <install-source-root>$(percept-root)
  ;


explicit install-user-bin ;
install install-user-bin
  : percept_verifier_mesh
    percept_mesh_diff
    eigen_verify
    mesh_transfer
    mesh_adapt
    rfsuite
  : <location>$(install-bin-dir)
  ;

explicit install-user-include ;
install install-user-include
  : [ path.glob-tree $(percept-root)/src : *.h *.hpp ]
  : <location>$(install-root)/percept/include <install-source-root>$(percept-root)/src
  ;

explicit install-user-lib ;
install install-user-lib
  : percept
    rfgen
  : <location>$(install-root)/percept/lib
  ;

explicit install-exe-targets ;
alias install-exe-targets : ;

#
# SECTION 4: Build configuration
#

local xml-files =
  ;

exe percept_utest
  :
    [ glob $(percept-root-test)/unit_tests/*.cpp ]
    [ glob $(percept-root-test)/unit_tests/stk_geom/*.cpp ]
    percept
    /sierra/stk_mesh//stk_mesh_fixtures
    /sierra/stk_mesh//stk_mesh_base
    /sierra/stk_util//stk_util_environment
    /sierra/stk_util//stk_util_parallel
    /sierra/stk_util//stk_util_use_case
    /sierra/stk_util//stk_util_diag
    /sierra/stk_util//stk_util_util
    /sierra/stk_util//stk_util_unit_test_support
    /sierra/stk_search//stk_search
    /sierra/stk_io//stk_io
    /sierra/stk_io//stk_io_util
    /sierra/seacas//iocgns
    /tpl/trilinos//intrepid
    /tpl/trilinos//shards
    /tpl/trilinos//teuchos
    /tpl/gtest//gtest
    /mpi//mpi
  : <tag>@sierra-exec-tag
  ;

exe percept_rtest
  :
    [ glob $(percept-root-test)/regression_tests/*.cpp ]
    percept
    /sierra/stk_mesh//stk_mesh_base
    /sierra/stk_util//stk_util_environment
    /sierra/stk_util//stk_util_parallel
    /sierra/stk_util//stk_util_use_case
    /sierra/stk_util//stk_util_diag
    /sierra/stk_util//stk_util_util
    /sierra/stk_util//stk_util_unit_test_support
    /sierra/stk_search//stk_search
    /sierra/stk_io//stk_io
    /sierra/stk_io//stk_io_util
    /sierra/stk_unit_test_utils//stk_unit_test_utils
    /sierra/seacas//iocgns
    /sierra/cubit//cubit_util
    /sierra/cubit//cubit_pgeom
    [ if-defined-val $(acis-root) : /sierra/cubit_acis//cubit_pgeom_acis ]
    /tpl/trilinos//intrepid
    /tpl/trilinos//shards
    /tpl/trilinos//teuchos
    /tpl/gtest//gtest
    /mpi//mpi
  : <tag>@sierra-exec-tag
    <include>$(cubit-root)/cubit/util
    <include>$(cubit-root)/cubit/pgeom
    [ if-defined-val $(acis-root) : <include>$(cubit_acis-root)/cubit_acis/pgeom ]
  ;

exe percept_verifier_mesh
  :
    [ glob $(percept-root-src)/percept/verifier/mesh/*.cpp ]
    percept
    /sierra/stk_mesh//stk_mesh_base
    /sierra/stk_util//stk_util_environment
    /sierra/stk_util//stk_util_use_case
    /sierra/stk_util//stk_util_parallel
    /sierra/stk_util//stk_util_diag
    /sierra/stk_util//stk_util_util
    /sierra/stk_io//stk_io
    /sierra/stk_io//stk_io_util
    /sierra/seacas//iocgns
    /tpl/trilinos//intrepid
    /tpl/trilinos//shards
    /tpl/trilinos//teuchos
    /tpl/gtest//gtest
    /mpi//mpi
  : <tag>@sierra-exec-tag
  ;

exe percept_mesh_diff
  :
    [ glob $(percept-root-src)/percept/mesh/diff/*.cpp ]
    percept
    /sierra/stk_mesh//stk_mesh_base
    /sierra/stk_util//stk_util_environment
    /sierra/stk_util//stk_util_use_case
    /sierra/stk_util//stk_util_parallel
    /sierra/stk_util//stk_util_diag
    /sierra/stk_util//stk_util_util
    /sierra/stk_io//stk_io
    /sierra/stk_io//stk_io_util
    /sierra/seacas//iocgns
    /tpl/trilinos//intrepid
    /tpl/trilinos//shards
    /tpl/trilinos//teuchos
    /tpl/gtest//gtest
    /mpi//mpi
  : <tag>@sierra-exec-tag
  ;

exe eigen_verify
  :
    [ glob $(percept-root-src)/percept/eigen_verify/*.cpp ]
    percept
    /sierra/stk_mesh//stk_mesh_base
    /sierra/stk_util//stk_util_environment
    /sierra/stk_util//stk_util_use_case
    /sierra/stk_util//stk_util_parallel
    /sierra/stk_util//stk_util_diag
    /sierra/stk_util//stk_util_util
    /sierra/stk_io//stk_io
    /sierra/stk_io//stk_io_util
    /sierra/seacas//iocgns
    /mpi//mpi
  : <tag>@sierra-exec-tag
  ;

exe mesh_transfer
  :
    [ glob $(percept-root-src)/percept/mesh_transfer/*.cpp ]
    percept
    /sierra/stk_mesh//stk_mesh_base
    /sierra/stk_util//stk_util_environment
    /sierra/stk_util//stk_util_use_case
    /sierra/stk_util//stk_util_parallel
    /sierra/stk_util//stk_util_diag
    /sierra/stk_util//stk_util_util
    /sierra/stk_io//stk_io
    /sierra/stk_io//stk_io_util
    /sierra/seacas//iocgns
    /mpi//mpi
  : <tag>@sierra-exec-tag
  ;


# heavy tests
exe percept_htest
  :
    [ glob $(percept-root-test)/heavy_tests/*.cpp ]

    percept
    /sierra/percept//percept
    /sierra/stk_mesh//stk_mesh_base
    /sierra/stk_util//stk_util_environment
    /sierra/stk_util//stk_util_parallel
    /sierra/stk_util//stk_util_use_case
    /sierra/stk_util//stk_util_diag
    /sierra/stk_util//stk_util_util
    /sierra/stk_search//stk_search
    /sierra/stk_io//stk_io
    /sierra/stk_io//stk_io_util
    /sierra/seacas//iocgns
    /tpl/trilinos//intrepid
    /tpl/trilinos//shards
    /tpl/trilinos//teuchos
    /tpl/gtest//gtest
    /mpi//mpi
  : <tag>@sierra-exec-tag
  ;

exe mesh_adapt
  :
    [ glob $(percept-root-src)/adapt/main/*.cpp ]
    percept
    /sierra/stk_mesh//stk_mesh_base
    /sierra/stk_util//stk_util_environment
    /sierra/stk_util//stk_util_parallel
    /sierra/stk_util//stk_util_use_case
    /sierra/stk_util//stk_util_diag
    /sierra/stk_util//stk_util_util
    /sierra/stk_search//stk_search
    /sierra/stk_io//stk_io
    /sierra/stk_io//stk_io_util
    /sierra/seacas//iocgns
    /sierra/cubit//cubit_util
    /sierra/cubit//cubit_pgeom
    [ if-defined-val $(acis-root) : /sierra/cubit_acis//cubit_pgeom_acis ]
    /tpl/trilinos//intrepid
    /tpl/trilinos//shards
    /tpl/trilinos//teuchos
    /tpl/gtest//gtest
    /mpi//mpi
  :
    <tag>@sierra-exec-tag
    <include>$(cubit-root)/cubit/util
    <include>$(cubit-root)/cubit/pgeom
    [ if-defined-val $(acis-root) : <include>$(cubit_acis-root)/cubit_acis/pgeom ]
  ;

exe rfgen_unit
  :
    [ glob $(percept-root-test)/unit_tests/rfgen/*.C ]
    rfgen
    /tpl/gtest//gtest
    /mpi//mpi
  : <tag>@sierra-exec-tag
  ;

exe rfsuite_unit
  :
    [ glob $(percept-root-test)/unit_tests/uq/*.cpp ]
    percept_uq
    /sierra/stk_mesh//stk_mesh_base
    /sierra/stk_mesh//stk_mesh_fixtures
    /tpl/gtest//gtest
    /mpi//mpi
  : <tag>@sierra-exec-tag
  ;

exe rfsuite
  :
    [ glob $(percept-root-src)/percept/uq/main/*.cpp ]
    percept_uq
    /sierra/stk_mesh//stk_mesh_base
    /sierra/stk_util//stk_util_environment
    /sierra/stk_util//stk_util_use_case
    /sierra/stk_util//stk_util_parallel
    /sierra/stk_util//stk_util_diag
    /sierra/stk_util//stk_util_util
    /sierra/stk_io//stk_io
    /sierra/stk_io//stk_io_util
    /sierra/seacas//iocgns
    /mpi//mpi
  : <tag>@sierra-exec-tag
  ;

lib percept
  :
    [ ifdevbuild
    # Any parameters within this 'ifdevbuild' block apply to development
    # builds only and will not be present for user builds.
      [ glob $(percept-root-src)/percept/*.cpp ]
      [ glob $(percept-root-src)/percept/function/*.cpp ]
      [ glob $(percept-root-src)/percept/function/internal/*.cpp ]
      [ glob $(percept-root-src)/percept/norm/*.cpp ]
      [ glob $(percept-root-src)/percept/mesh/gen/*.cpp ]
      [ glob $(percept-root-src)/percept/element/intrepid/*.cpp ]
      [ glob $(percept-root-src)/percept/mesh/mod/smoother/*.cpp ]
      [ glob $(percept-root-src)/percept/mesh/geometry/kernel/*.cpp ]
      [ glob $(percept-root-src)/percept/mesh/geometry/kernel/search/*.cpp ]
      [ glob $(percept-root-src)/percept/mesh/geometry/kernel/xfer/*.cpp ]
      [ glob $(percept-root-src)/percept/mesh/geometry/recovery/*.cpp ]
      [ glob $(percept-root-src)/percept/mesh/geometry/volume/*.cpp ]
      [ glob $(percept-root-src)/percept/mesh/geometry/volume/sierra_only/*.cpp ]
      [ glob $(percept-root-src)/percept/mesh/geometry/stk_geom/*.cpp ]
      [ glob $(percept-root-src)/percept/mesh/geometry/stk_geom/3D/*.cpp ]
      [ glob $(percept-root-src)/percept/xfer/*.cpp ]
      [ glob $(percept-root-src)/percept/util/*.cpp ]
      [ glob $(percept-root-src)/percept/master_element/*.cpp ]
      [ glob $(percept-root-src)/percept/master_element/*.F ]
      [ glob $(percept-root-src)/percept/stk_rebalance/*.cpp ]
      [ glob $(percept-root-src)/percept/stk_rebalance_utils/*.cpp ]
      [ glob $(percept-root-src)/percept/fixtures/*.cpp ]
      [ glob $(percept-root-src)/percept/structured/*.cpp ]

      [ glob $(percept-root-src)/adapt/*.cpp ]
      [ glob $(percept-root-src)/adapt/sierra_element/*.cpp ]
      [ glob $(percept-root-src)/adapt/geometry/*.cpp ]
      [ glob $(percept-root-src)/adapt/markers/*.cpp ]
    ]
    /tpl/trilinos-kokkoscore//kokkoscore
    /sierra/stk_mesh//stk_mesh_base
    /sierra/stk_util//stk_util_environment
    /sierra/stk_util//stk_util_parallel
    /sierra/stk_util//stk_util_diag
    /sierra/stk_util//stk_util_util
    /sierra/stk_util//stk_util_registry
    /sierra/stk_expreval//stk_expreval
    /sierra/stk_search//stk_search
    /sierra/stk_transfer//stk_transfer
    /sierra/stk_io//stk_io
    /sierra/stk_io//stk_io_util
    /sierra/Sierra//audit
    /sierra/seacas//iocgns
    /sierra/seacas//io_info_lib
    /sierra/cubit//cubit_util
    /sierra/cubit//cubit_pgeom
    [ if-defined-val $(acis-root) : /sierra/cubit_acis//cubit_pgeom_acis ]
    /tpl/trilinos//shards
    /tpl/trilinos//intrepid
    /tpl/boost-program-options//boost_program_options
    /tpl/boost-system//boost_system
    /tpl/boost-graph//boost_graph
    /tpl/boost-graph-parallel//boost_graph_parallel
    /tpl/opennurbs//opennurbs
    /tpl/yaml-cpp//yaml-cpp
    /mpi//mpi
  : <define>STK_PERCEPT_LITE=0
    [ ifuserbuild
    # Any parameters within this 'ifuserbuild' block apply to user
    # builds only and will not be present for developer builds.
        <file>$(percept-root)/lib/libpercept.a
    ]
    <include>$(cubit-root)/cubit/util
    <include>$(cubit-root)/cubit/pgeom
    [ if-defined-val $(acis-root) : <include>$(cubit_acis-root)/cubit_acis/pgeom ]
  ;


lib rfgen
  :
    [ ifdevbuild
    # Any parameters within this 'ifdevbuild' block apply to development
    # builds only and will not be present for user builds.
        [ glob $(percept-root)/src/percept/rfgen/*.C ]
    ]
    /tpl/trilinos//teuchos
    /tpl/trilinos//anasazi
    /tpl/trilinos//epetra
    /tpl/trilinos//shards
  :
    [ ifuserbuild
    # Any parameters within this 'ifuserbuild' block apply to user
    # builds only and will not be present for developer builds.
        <file>$(percept-root)/lib/librfgen.a
    ]
  ;

lib percept_uq
  :
    [ ifdevbuild
    # Any parameters within this 'ifdevbuild' block apply to development
    # builds only and will not be present for user builds.
        [ glob $(percept-root)/src/percept/uq/*.cpp ]
    ]
    rfgen
    percept
    /sierra/stk_mesh//stk_mesh_base
    /tpl/trilinos//shards
  :
    [ ifdevbuild
    # Any parameters within this 'ifdevbuild' block apply to development
    # builds only and will not be present for user builds.
    ]
  ;

